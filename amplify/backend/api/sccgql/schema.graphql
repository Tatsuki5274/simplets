type Company #会社
@model
@auth(
  rules: [
    {allow: groups, groups: ["Admin"]}
    {allow: private}

    {allow: private, provider: iam ,operations:[read]}
  ]
)
{
  id: ID!

  name: String!
  startMonth: Int!
  shortName: String
  url: AWSURL

  
}

enum EmployeeType {
  OTHER #不明・その他
  NORMAL  #通常社員
  MANAGER #マネージャー
  SUPER_MANAGER #特権マネージャー
}

enum BooleanType {
  TRUE
  FALSE
}

# ユーザーはcognitoで管理しています。
# このEmployeeは名簿として機能します。認証とは関係がありません。
type Employee #社員
@key(fields: ["companyID", "username"])
@key(fields: ["companyID", "localID"], name: "employee_local_id", queryField: "listEmployeeLocalID")
@key(fields: ["companyID", "manager", "isDeleted"], name: "employee_manager", queryField: "listEmployeesManager")
# @key(fields: ["companyID", "employeeGroupLocalId", "username"], name: "employee_manager_group", queryField: "listEmployeesManagerGroup")
@auth(
  rules:[
    {allow: groups, groups: ["Admin"]}

    # 社員本人の持つ権限
    {allow: owner, ownerField: "username", operations: [read]}

    { allow: private, provider: iam, operations: [read] }

    {allow: private}
  ]
)
@model
{
  companyID: ID!
  username: ID! #cognito username

  localID: ID! #社員番号などの社内ID・UUID
  employeeGroupLocalId: ID!
  superiorUsername: ID!

  # no: String #社員番号
  firstName: String!
  lastName: String!
  grade: String! #等級
  email: String!
  superior: Employee @connection(fields: ["companyID", "superiorUsername"])  #上司(所属長や部門長)
  group: Group @connection(fields: ["companyID", "employeeGroupLocalId"])  #所属部門
  company: Company @connection (fields: ["companyID"])

  manager: EmployeeType!  #マネージャー
  isDeleted: BooleanType!
}

type Group #部門
@model
@key(fields: ["companyID", "localID"])
@auth(
  rules: [
    {allow: groups, groups: ["Admin"]}
    {allow: private}

    {allow: private, provider: iam ,operations:[read]}
  ]
)
{
  companyID: ID!
  localID: ID!  #ソート
  
  # company: Company @connection  グループフィールドに置き換え
  name: String! #部門名

  createdAt: AWSDateTime!
}

type Category
@model
@key(fields: ["companyID", "localID"])
@auth(
  rules: [
    {allow: groups, groups: ["Admin"]}
    {allow: private}
    {allow: private, provider: iam ,operations:[read]}

  ]
)
{
  companyID: ID!
  localID: ID!  #ソート
  # company: Company @connection  # グループフィールドへ置き換え

  name: String! #カテゴリ名
}


type Sheet
@model
@key(fields: ["companyID", "reviewee", "year"])
@key(fields: ["companyID", "reviewee"], name: "sheet_reviewee", queryField: "listSheetReviewee")
@key(fields: ["companyID", "year"], name: "sheet_year", queryField: "listSheetYear")
@key(fields: ["companyID", "sheetGroupLocalId"], name: "sheet_group", queryField: "listSheetGroup")
@auth(
  rules: [
    {allow: groups, groups: ["Admin"]}

    # オーナーフィールド
    {allow: owner, ownerField: "topReviewers", operations: [update, read]}
    {allow: owner, ownerField: "secondReviewers", operations: [update, read]}
    {allow: owner, ownerField: "reviewee", operations: [create, update, read]}
    {allow: owner, ownerField: "referencer", operations: [read]}

    { allow: private, provider: iam, operations: [read, update] }
    
  ]
)
{
  companyID: ID!
  year: Int!  #実施年度
  # sheetSectionKey: String!

  grade: String! #等級
  careerPlan: String  #キャリア計画本人希望
  careerPlanComment: String #話し合い結果コメント
  reviewComment: String #年間評価コメント
  reviewDate: AWSDate #年間評価実施日時
  selfCheckDate: AWSDate #本人確認（日付）
  firstComment: String #部門長コメント
  firstCheckDate: AWSDate #部門長確認（日付）
  secondComment: String #所属長コメント
  secondCheckDate: AWSDate #所属長確認日付
  overAllEvaluation: Int  #総合評価
  statusValue: Int  #承認ステータス値

  # インタビュー情報
  interviewPlanDate: AWSDate    # 目標設定
  interviewPlanComment: String
  InterviewMid1Date: AWSDate    # 中間1
  InterviewMid1Comment: String
  InterviewMid2Date: AWSDate    # 中間2
  InterviewMid2Comment: String
  InterviewMid3Date: AWSDate    # 中間3
  InterviewMid3Comment: String

  revieweeUsername: ID!
  secondUsername: ID!

  # connection
  sheetGroupLocalId: ID!
  sheetGroupName: String
  # group: Group @connection(fields: ["companyID", "sheetGroupLocalId"])
  revieweeEmployee: Employee @connection(fields: ["companyID", "revieweeUsername"])  #被評価者
  secondEmployee: Employee @connection(fields: ["companyID", "secondUsername"])  #所属長
  section: [Section] @connection(fields: ["companyID"]) # companyID.reviewee.year

  #　オーナーフィールド
  referencer: [String!] #参照者
  reviewee: String! #被評価者
  topReviewers: [String!] #部門長権限
  secondReviewers: [String!] #所属長権限
}

type Section
@model
@key(fields: ["sheetKeys", "sectionCategoryLocalId"])
@auth(
  rules: [
    {allow: groups, groups: ["Admin"]}

    # オーナーフィールド
    {allow: owner, ownerField: "topReviewers", operations: [read]}
    {allow: owner, ownerField: "secondReviewers", operations: [read]}
    {allow: owner, ownerField: "reviewee", operations: [create, update, read, delete]}
    {allow: owner, ownerField: "referencer", operations: [read]}

    {allow: private, provider: iam ,operations:[read]}
  ]
)
{
  sheetKeys: ID! # companyID.reviewee.year の形式として保持
  sectionCategoryLocalId: ID!
  sectionCategoryName: String
  # sectionCategoryId: ID!
  companyID: ID!


  objective: [Objective] @connection(fields: ["sheetKeys"]) # sheetKeys.sectionCategoryLocalId
  category: Category @connection(fields: ["companyID", "sectionCategoryLocalId"])

  #　オーナーフィールド
  reviewee: String #被評価者
  topReviewers: [String!] #部門長権限
  secondReviewers: [String!] #所属長権限
  referencer: [String!] #参照者
}

type Objective
@model
@key(fields: ["sectionKeys", "createdAt"])
# @key(fields: ["sectionKeys", "objectiveCategoryDate"], name: "objective_sheet_category")
@auth(
  rules: [
    {allow: groups, groups: ["Admin"]}

    # オーナーフィールド
    {allow: owner, ownerField: "topReviewers", operations: [update, read]}
    {allow: owner, ownerField: "secondReviewers", operations: [update, read]}
    {allow: owner, ownerField: "reviewee", operations: [create, update, read, delete]}
    {allow: owner, ownerField: "referencer", operations: [read]}

    { allow: private, provider: iam, operations: [read] }
  ]
)
{
  sectionKeys: ID!  # sheetKeys.sectionCategoryLocalId の形式で保持
  createdAt: AWSDateTime!
  
  # objectiveCategoryLocalId: ID!
  companyID: ID!

  content: String! #目標本文
  result: String  #実績
  priority: String #優先順位
  selfEvaluation: Int #自己評価
  firstEvaluation: Int #所属長評価
  lastEvaluation: Int #最終評価

  progress: Int #進捗率(%)

  #expected date
  expStartDate: AWSDate  #開始予定日
  expDoneDate: AWSDate  #完了予定日

  # sheet: Sheet @connection
  # objectiveSectionId: ID!
  # section: Section @connection(fields: ["objectiveSectionId"])
  
  #　オーナーフィールド
  reviewee: String #被評価者
  topReviewers: [String!] #部門長権限
  secondReviewers: [String!] #所属長権限
  referencer: [String!] #参照者

}


enum ReportWorkingStatus {
  OK
  InTask
  InProblem
}

type RevieweeReportComment
{
  work: String #作業内容
  other: String #その他コメント
  status: String  #作業状況コメント
}

type ReviewerReportComment
{
  superior: String #所属長コメント
}


type Superior
{
  # lastname, firstname 名前が必要？
  username: String
  email: String
  # superior: Superior  # 階層が必要？
}

type Report
@model
@key(fields: ["reviewee", "date"])
@key(fields: ["companyID", "date"], name: "report_company_date", queryField: "listReportsCompanyDate")
# @key(fields: ["companyID", "reviewee"], name: "report_company_reviewee", queryField: "listReportsReviewee")
# @key(fields: ["companyID", "date"], name: "report_company_date", queryField: "listReportsDate")
@auth(
  rules: [
    {allow: groups, groups: ["Admin"]}

    # オーナーフィールド
    {allow: owner, ownerField: "reviewee", operations: [create, update, read]}
    {allow: owner, ownerField: "referencer", operations: [read]}
    {allow: owner, ownerField: "reviewer", operations: [read, update]}
  ]
)
{
  reviewee: ID!
  date: AWSDate!  #1970-01-01Z の形式で格納

  reviewer: [String]
  companyID: ID
  referencer: [String] #参照者
  # superior: Superior # 報告書作成時の所属長を保存する必要がある？
  
  revieweeComments: RevieweeReportComment 
  # @auth(rules: [
  #     { allow: owner, ownerField: "reviewee"}
  #     # { allow: owner, ownerField: "reviewee", operations: [create, update, read] }
  #     # { allow: owner, ownerField: "reviewer", operations: [read] }      
  #     # { allow: owner, ownerField: "referencer", operations: [read] }      
  #   ])
    #   # シングルフィールドの検証
    #   revieweeTest: String @auth(rules: [
    #   { allow: owner, ownerField: "reviewee"}
    #   # { allow: owner, ownerField: "reviewee", operations: [create, update, read] }
    #   # { allow: owner, ownerField: "reviewer", operations: [read] }      
    #   # { allow: owner, ownerField: "referencer", operations: [read] }      
    # ])
  reviewerComments: ReviewerReportComment 
  # @auth(rules: [
  #     # { allow: owner, ownerField: "reviewer" }
  #     # { allow: owner, ownerField: "reviewer", operations: [update, read] }
  #     { allow: owner, ownerField: "reviewee", operations: [read] }      
  #     # { allow: owner, ownerField: "referencer", operations: [read] }      
  #   ])
  workStatus: ReportWorkingStatus #作業状況
  # revieweeEmail: String #報告者のメールアドレス
  revieweeEmployee: Employee @connection(fields: ["companyID", "reviewee"])  #被評価者
}

# type Query {
#   #listSheetsLtGrade: String @function(name: "listSheetsLtGrade_${env}")
#   # listSheetsLtGrade: [Sheet] @function(name: "listSheetsLtGrade_${env}")
#   #   @auth(rules:[
#   #     {allow: groups, groups: ["Admin", "Manager"]}
#   #     {allow: private, operations: []}
#   #   ])
#   # approvalStatusReferencer(sheetId: String): String @function(name: "approvalStatusReferencer_${env}")
#   #   @auth(rules:[
#   #     {allow: private}
#   #   ])
# }

input sendEmailInput{
  to: [String]!
  cc: [String]
  bcc: [String]
  subject: String!
  body: String!
}


type Mutation{
  # 廃止
  approvalStatusManager(action: String, sheetId: String): String @function(name: "approvalStatusManager_${env}")
    @auth(rules:[
      {allow: private}
    ])
  
  # メールを送信する関数を呼び出す
  sendEmail(input: sendEmailInput): String
    @function(name: "sendEmail-${env}")
    @auth(rules:[
      {allow: private}
    ])
}